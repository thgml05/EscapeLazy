import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { TaskCard } from '@/components/TaskCard';
import { ProgressBar } from '@/components/ProgressBar';
import { CalendarView } from '@/components/CalendarView';
import { RewardSystem } from '@/components/RewardSystem';
import { AddTaskModal } from '@/components/AddTaskModal';
import { ReprojectModal } from '@/components/ReprojectModal';
import { TeamManagement } from '@/components/TeamManagement';
import { PostponeTasksModal } from '@/components/PostponeTasksModal';
import {
  getProjects,
  getProjectTasks,
  updateTaskStatus,
  saveProjectTasks,
  updateTaskDueDate,
  updateTask,
  deleteTask,
  addUserTask,
  updateTaskPriority,
  completeTaskWithRewards,
  updateProject,
  getProjectById,
  syncProjectProgress,
  convertToTeamProject,
} from '@/utils/projectService';
import { getUserTeams } from '@/utils/teamService';
import { Project, ProjectTask } from '@/types/project';
import { useToast } from '@/hooks/use-toast';
import {
  ArrowLeft,
  Calendar,
  List,
  Plus,
  Trophy,
  RefreshCw,
  Users,
  Target,
  Settings,
} from 'lucide-react';
import {
  DragDropContext,
  Droppable,
  Draggable,
  DropResult,
} from '@hello-pangea/dnd';
import { format, parse } from 'date-fns';
import { ko } from 'date-fns/locale';
import {
  scheduleTasksToDeadline,
  groupAndSortTasksByDate,
} from '@/utils/scheduleService';

const ProjectDetails = () => {
  const { projectId } = useParams<{ projectId: string }>();
  const navigate = useNavigate();
  const { toast } = useToast();

  const [project, setProject] = useState<Project | null>(null);
  const [projectTasks, setProjectTasks] = useState<ProjectTask[]>([]);
  const [showAddTaskModal, setShowAddTaskModal] = useState(false);
  const [showRewards, setShowRewards] = useState(false);
  const [showReprojectModal, setShowReprojectModal] = useState(false);
  const [apiKey, setApiKey] = useState('');
  const [activeTab, setActiveTab] = useState('calendar');
  const [currentDate, setCurrentDate] = useState('');
  const [showTeamSelect, setShowTeamSelect] = useState(false);
  const [selectedTeamId, setSelectedTeamId] = useState<string>('');

  // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ (Ïã§Ï†úÎ°úÎäî Ïù∏Ï¶ù ÏãúÏä§ÌÖúÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº Ìï®)
  const currentUser = {
    id: 'user-1',
    name: 'ÏÇ¨Ïö©Ïûê',
    email: 'user@example.com',
  };

  useEffect(() => {
    if (!projectId) {
      navigate('/');
      return;
    }

    // API ÌÇ§ Î°úÎìú
    const savedApiKeyData = localStorage.getItem('gemini_api_key_data');
    if (savedApiKeyData) {
      try {
        const apiKeyData = JSON.parse(savedApiKeyData);
        const expiresAt = new Date(apiKeyData.expiresAt);
        const now = new Date();

        if (now < expiresAt) {
          setApiKey(apiKeyData.key);
        } else {
          localStorage.removeItem('gemini_api_key_data');
          const savedApiKey = localStorage.getItem('gemini_api_key');
          if (savedApiKey) {
            setApiKey(savedApiKey);
          }
        }
      } catch (error) {
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
          setApiKey(savedApiKey);
        }
      }
    } else {
      const savedApiKey = localStorage.getItem('gemini_api_key');
      if (savedApiKey) {
        setApiKey(savedApiKey);
      }
    }

    const projects = getProjects();
    const currentProject = projects.find((p) => p.id === projectId);

    if (!currentProject) {
      navigate('/');
      return;
    }

    setProject(currentProject);
    const tasks = getProjectTasks(projectId);
    setProjectTasks(tasks);
  }, [projectId, navigate]);

  const handleTaskToggle = (taskId: string, completed?: boolean) => {
    if (!project) return;

    const task = projectTasks.find((t) => t.id === taskId);
    if (!task) return;

    // completed ÌååÎùºÎØ∏ÌÑ∞Í∞Ä Î™ÖÏãúÏ†ÅÏúºÎ°ú Îì§Ïñ¥Ïò§Î©¥ Í∑∏ Í∞íÏúºÎ°ú, ÏïÑÎãàÎ©¥ Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ
    const willComplete =
      typeof completed === 'boolean' ? completed : !task.completed;

    if (willComplete) {
      // ÏûëÏóÖ ÏôÑÎ£å Ïãú Î≥¥ÏÉÅ ÏãúÏä§ÌÖú Ï†ÅÏö©
      const rewardResult = completeTaskWithRewards(taskId, project.id);
      if (rewardResult) {
        toast({
          title: 'ÌõåÎ•≠Ìï¥Ïöî! üéâ',
          description: `"${task.title}" ÏôÑÎ£å! +${rewardResult.points}Ï†ê ÌöçÎìù!`,
        });
        if (rewardResult.newBadges.length > 0) {
          rewardResult.newBadges.forEach((badge: any) => {
            toast({
              title: 'ÏÉàÎ°úÏö¥ Ïπ≠Ìò∏ ÌöçÎìù! üèÜ',
              description: `${badge.name} - ${badge.description}`,
            });
          });
        }
        if (rewardResult.newLevel > (project.level || 1)) {
          toast({
            title: 'Î†àÎ≤®ÏóÖ! ‚≠ê',
            description: `Î†àÎ≤® ${rewardResult.newLevel} Îã¨ÏÑ±!`,
          });
        }
      }
    } else {
      // ÏûëÏóÖ Ï∑®ÏÜå Ïãú
      const updatedTasks = projectTasks.map((task) =>
        task.id === taskId ? { ...task, completed: false } : task
      );
      setProjectTasks(updatedTasks);
      updateTaskStatus(taskId, false);
    }

    // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®
    const updatedProjects = getProjects();
    const updatedProject = updatedProjects.find((p) => p.id === projectId);
    if (updatedProject) {
      setProject(updatedProject);
    }

    // ÏûëÏóÖ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
    const updatedTasks = getProjectTasks(projectId);
    setProjectTasks(updatedTasks);
  };

  const handleAddTask = (taskData: {
    title: string;
    description: string;
    dueDate: string;
    priority: 'low' | 'medium' | 'high' | 'critical';
    difficulty: 'easy' | 'medium' | 'hard';
  }) => {
    if (!project) return;

    const newTask = addUserTask(project.id, taskData);
    setProjectTasks([...projectTasks, newTask]);

    toast({
      title: 'ÏûëÏóÖÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§! ‚ú®',
      description: 'ÏßÅÏ†ë Ï∂îÍ∞ÄÌïú ÏûëÏóÖÏùÄ Î≥¥ÎÑàÏä§ Ìè¨Ïù∏Ìä∏Î•º Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî!',
    });
  };

  const handlePriorityChange = (
    taskId: string,
    priority: 'low' | 'medium' | 'high' | 'critical'
  ) => {
    updateTaskPriority(taskId, priority);

    // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    const updatedTasks = projectTasks.map((task) =>
      task.id === taskId ? { ...task, priority } : task
    );
    setProjectTasks(updatedTasks);

    toast({
      title: 'Ïö∞ÏÑ†ÏàúÏúÑÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!',
      description: 'Ìè¨Ïù∏Ìä∏Í∞Ä Ïû¨Í≥ÑÏÇ∞ÎêòÏóàÏñ¥Ïöî.',
    });
  };

  const handleReproject = (
    newTasks: ProjectTask[],
    updatedProject: Project
  ) => {
    if (!project) return;

    // Í∏∞Ï°¥ ÏûëÏóÖÎì§ÏùÑ ÏÉàÎ°úÏö¥ ÏûëÏóÖÏúºÎ°ú ÍµêÏ≤¥
    setProjectTasks(newTasks);
    saveProjectTasks(project.id, newTasks);

    // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
    setProject(updatedProject);
    updateProject(project.id, updatedProject);

    toast({
      title: 'ÌîÑÎ°úÏ†ùÌä∏Í∞Ä Ïû¨Î∂ÑÌï¥ÎêòÏóàÏäµÎãàÎã§! üîÑ',
      description: `${newTasks.length}Í∞úÏùò ÏÉàÎ°úÏö¥ ÏûëÏóÖÏúºÎ°ú Î∂ÑÌï¥ÎêòÏóàÏñ¥Ïöî.`,
    });
  };

  const todayTasks = projectTasks.filter((task) => {
    const today = new Date();
    const todayString = today.toLocaleDateString('ko-KR', {
      month: 'long',
      day: 'numeric',
      weekday: 'short',
    });
    return task.dueDate === todayString;
  });

  const completedTasks = projectTasks.filter((task) => task.completed).length;

  // DnD Ìï∏Îì§Îü¨
  const handleDragEnd = (result: DropResult) => {
    if (!result.destination) return;
    const reordered = Array.from(projectTasks);
    const [removed] = reordered.splice(result.source.index, 1);
    reordered.splice(result.destination.index, 0, removed);
    setProjectTasks(reordered);
    // ÏàúÏÑú Î≥ÄÍ≤ΩÏùÑ localStorageÏóêÎèÑ Î∞òÏòÅ
    if (project) saveProjectTasks(project.id, reordered);
  };

  // ÎÇ†ÏßúÎ≥Ñ Í∑∏Î£πÌïë (Ïö∞ÏÑ†ÏàúÏúÑÏóê Îî∞Îùº Ï†ïÎ†¨)
  const tasksByDate = groupAndSortTasksByDate(projectTasks);
  const sortedDates = Object.keys(tasksByDate).sort((a, b) => {
    // ÎÇ†Ïßú Ïò§Î¶ÑÏ∞®Ïàú Ï†ïÎ†¨
    const parseDate = (d: string) => {
      // "2025ÎÖÑ 7Ïõî 2Ïùº (Ïàò)" ÎòêÎäî ISO
      if (d.includes('-')) return new Date(d);
      try {
        const match = d.match(/(\d+)Ïõî (\d+)Ïùº/);
        if (match)
          return new Date(
            new Date().getFullYear(),
            Number(match[1]) - 1,
            Number(match[2])
          );
      } catch {}
      return new Date(d);
    };
    return parseDate(a).getTime() - parseDate(b).getTime();
  });

  // ÎÇ†ÏßúÎ≥Ñ Î≥¥Í∏∞ÏóêÏÑú ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ìï∏Îì§Îü¨
  const handleByDateDragEnd = (result: DropResult) => {
    if (!result.destination) return;
    const sourceDate = result.source.droppableId;
    const destDate = result.destination.droppableId;
    const taskId = result.draggableId;
    if (sourceDate === destDate) return;
    // ÎÇ†Ïßú Î≥ÄÍ≤Ω
    const updatedTasks = projectTasks.map((task) =>
      task.id === taskId ? { ...task, dueDate: destDate } : task
    );
    setProjectTasks(updatedTasks);
    if (project) saveProjectTasks(project.id, updatedTasks);
    updateTaskDueDate(taskId, destDate);
  };

  // Ï†ÑÏ≤¥ ÏûëÏóÖ ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (Í∞ôÏùÄ ÎÇ†Ïßú ÎÇ¥ÏóêÏÑúÎäî Ïö∞ÏÑ†ÏàúÏúÑÏàú)
  const sortedTasks = [...projectTasks].sort((a, b) => {
    const parseDate = (d: string) => {
      if (d.includes('-')) return new Date(d);
      try {
        const match = d.match(/(\d+)Ïõî (\d+)Ïùº/);
        if (match)
          return new Date(
            new Date().getFullYear(),
            Number(match[1]) - 1,
            Number(match[2])
          );
      } catch {}
      return new Date(d);
    };

    const dateA = parseDate(a.dueDate);
    const dateB = parseDate(b.dueDate);

    // ÎÇ†ÏßúÍ∞Ä Îã§Î•¥Î©¥ ÎÇ†ÏßúÏàú Ï†ïÎ†¨
    if (dateA.getTime() !== dateB.getTime()) {
      return dateA.getTime() - dateB.getTime();
    }

    // Í∞ôÏùÄ ÎÇ†ÏßúÎ©¥ Ïö∞ÏÑ†ÏàúÏúÑÏàú Ï†ïÎ†¨
    const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
    const priorityA = priorityOrder[a.priority || 'medium'];
    const priorityB = priorityOrder[b.priority || 'medium'];

    if (priorityA !== priorityB) {
      return priorityB - priorityA; // ÎÜíÏùÄ Ïö∞ÏÑ†ÏàúÏúÑÍ∞Ä Î®ºÏ†Ä
    }

    // Ïö∞ÏÑ†ÏàúÏúÑÎèÑ Í∞ôÏúºÎ©¥ ÏõêÎûò ÏàúÏÑú Ïú†ÏßÄ
    return a.originalIndex - b.originalIndex;
  });

  const handleTaskEdit = (
    taskId: string,
    updates: { title: string; description: string; dueDate: string }
  ) => {
    const updatedTasks = projectTasks.map((task) =>
      task.id === taskId ? { ...task, ...updates } : task
    );
    setProjectTasks(updatedTasks);
    updateTask(taskId, updates);
    if (project) saveProjectTasks(project.id, updatedTasks);
  };

  const handleTaskDelete = (taskId: string) => {
    const updatedTasks = projectTasks.filter((task) => task.id !== taskId);
    setProjectTasks(updatedTasks);
    deleteTask(taskId);
    if (project) saveProjectTasks(project.id, updatedTasks);
  };

  const handleTaskUpdate = () => {
    loadProject();
    syncProjectProgress();
  };

  const handleTasksPostponed = () => {
    loadProject();
  };

  const getProgressPercentage = () => {
    if (!project || project.totalTasks === 0) return 0;
    return Math.round((project.completedTasks / project.totalTasks) * 100);
  };

  const getDaysUntilDeadline = () => {
    if (!project) return 0;
    const deadline = new Date(project.deadline);
    const today = new Date();
    const diffTime = deadline.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  };

  const getDeadlineStatus = () => {
    const daysLeft = getDaysUntilDeadline();
    if (daysLeft < 0) return { text: 'ÎßàÍ∞êÏùº ÏßÄÎÇ®', color: 'text-red-600' };
    if (daysLeft === 0) return { text: 'Ïò§Îäò ÎßàÍ∞ê', color: 'text-orange-600' };
    if (daysLeft <= 3)
      return { text: `${daysLeft}Ïùº ÎÇ®Ïùå`, color: 'text-yellow-600' };
    return { text: `${daysLeft}Ïùº ÎÇ®Ïùå`, color: 'text-green-600' };
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'critical':
        return 'bg-red-100 text-red-800';
      case 'high':
        return 'bg-orange-100 text-orange-800';
      case 'medium':
        return 'bg-yellow-100 text-yellow-800';
      case 'low':
        return 'bg-green-100 text-green-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'hard':
        return 'bg-purple-100 text-purple-800';
      case 'medium':
        return 'bg-blue-100 text-blue-800';
      case 'easy':
        return 'bg-green-100 text-green-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  const loadProject = () => {
    if (!projectId) return;

    const projectData = getProjectById(projectId);
    const projectTasks = getProjectTasks(projectId);

    setProject(projectData);
    setProjectTasks(projectTasks);
  };

  if (!project) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        Î°úÎî© Ï§ë...
      </div>
    );
  }

  const deadlineStatus = getDeadlineStatus();
  const userTeams = getUserTeams(currentUser.id);
  const isTeamProject = project.isTeamProject && project.teamId;

  // Ïö∞ÏÑ†ÏàúÏúÑ Ï†ïÎ†¨ Ìï®Ïàò Ï∂îÍ∞Ä
  const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
  function sortByPriority(tasks: ProjectTask[]) {
    return [...tasks].sort((a, b) => {
      const pa = priorityOrder[a.priority || 'medium'];
      const pb = priorityOrder[b.priority || 'medium'];
      if (pa !== pb) return pb - pa;
      return 0;
    });
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-cream-50 via-white to-sage-50">
      <div className="container mx-auto px-4 py-8 max-w-6xl">
        {/* Header with Back Button */}
        <div className="flex items-center gap-4 mb-8">
          <Button
            variant="outline"
            onClick={() => navigate('/')}
            className="rounded-xl border-2 border-gray-200 bg-white/80 backdrop-blur-sm hover:bg-white button-3d"
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            ÎèåÏïÑÍ∞ÄÍ∏∞
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl font-bold text-gray-800">{project.name}</h1>
            <p className="text-gray-600">ÎßàÍ∞êÏùº: {project.deadline}</p>
          </div>
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              onClick={() => setShowRewards(!showRewards)}
              className="rounded-xl border-2 border-gray-200 hover:border-coral-300"
            >
              <Trophy className="w-4 h-4 mr-2" />
              ÏÑ±Í≥º Î≥¥Í∏∞
            </Button>
            {apiKey && (
              <Button
                variant="outline"
                onClick={() => setShowReprojectModal(true)}
                className="rounded-xl border-2 border-gray-200 hover:border-orange-300"
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Ïû¨Î∂ÑÌï¥
              </Button>
            )}
            <Button
              onClick={() => setShowAddTaskModal(true)}
              className="rounded-xl bg-gradient-to-r from-coral-500 to-coral-600 hover:from-coral-600 hover:to-coral-700 text-white border-0 button-3d"
            >
              <Plus className="w-4 h-4 mr-2" />
              ÏûëÏóÖ Ï∂îÍ∞Ä
            </Button>
          </div>
        </div>

        {/* Î≥¥ÏÉÅ ÏãúÏä§ÌÖú */}
        {showRewards && (
          <div className="mb-8">
            <RewardSystem />
          </div>
        )}

        {/* Progress Section */}
        <ProgressBar
          completed={completedTasks}
          total={projectTasks.length}
          projectName={project.name}
        />

        {/* Tabs for different views */}
        <Tabs
          value={activeTab}
          onValueChange={setActiveTab}
          className="w-full mt-8"
        >
          <TabsList className="grid w-full grid-cols-4 rounded-2xl bg-white border-2 border-gray-200 p-1">
            <TabsTrigger
              value="calendar"
              className="rounded-xl flex items-center gap-2"
            >
              <Calendar className="w-4 h-4" />
              Îã¨Î†• Î∑∞
            </TabsTrigger>
            <TabsTrigger
              value="tasks"
              className="rounded-xl flex items-center gap-2"
            >
              <List className="w-4 h-4" />
              Ï†ÑÏ≤¥ ÏûëÏóÖ
            </TabsTrigger>
            <TabsTrigger
              value="team"
              className="rounded-xl flex items-center gap-2"
            >
              <Users className="w-4 h-4" />ÌåÄ Í¥ÄÎ¶¨
            </TabsTrigger>
            <TabsTrigger
              value="rewards"
              className="rounded-xl flex items-center gap-2"
            >
              <Settings className="w-4 h-4" />
              Î≥¥ÏÉÅ ÏãúÏä§ÌÖú
            </TabsTrigger>
          </TabsList>

          <TabsContent value="calendar" className="mt-6">
            <CalendarView
              projectId={project.id}
              tasks={projectTasks}
              onTaskUpdate={handleTaskUpdate}
              onDateSelect={setCurrentDate}
            />
            {currentDate && (
              <PostponeTasksModal
                projectId={project.id}
                currentDate={currentDate}
                onTasksPostponed={handleTasksPostponed}
              />
            )}
          </TabsContent>
          <TabsContent value="tasks" className="space-y-6 mt-6">
            <h2 className="text-xl font-bold text-gray-800 mb-2">
              Ï†ÑÏ≤¥ ÏûëÏóÖ (ÎÇ†ÏßúÏàú)
            </h2>
            <div className="space-y-3">
              {sortByPriority(sortedTasks).map((task) => (
                <TaskCard
                  key={task.id}
                  task={task}
                  onToggle={handleTaskToggle}
                  onEdit={handleTaskEdit}
                  onDelete={handleTaskDelete}
                  onPriorityChange={handlePriorityChange}
                />
              ))}
            </div>
          </TabsContent>
          <TabsContent value="team" className="space-y-4">
            {isTeamProject ? (
              <TeamManagement
                currentUserId={currentUser.id}
                currentUserName={currentUser.name}
                currentUserEmail={currentUser.email}
              />
            ) : (
              <Card>
                <CardContent className="text-center py-8">
                  <Users className="w-12 h-12 mx-auto text-gray-400 mb-4" />
                  <h3 className="text-lg font-medium mb-2">
                    ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏïÑÎãôÎãàÎã§
                  </h3>
                  <p className="text-gray-600 mb-4">
                    Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Îäî Í∞úÏù∏ ÌîÑÎ°úÏ†ùÌä∏ÏûÖÎãàÎã§. ÌåÄ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ ÌåÄ
                    ÌîÑÎ°úÏ†ùÌä∏Î°ú Î≥ÄÌôòÌïòÏÑ∏Ïöî.
                  </p>
                  {showTeamSelect ? (
                    <div className="space-y-4">
                      <Select
                        value={selectedTeamId}
                        onValueChange={setSelectedTeamId}
                      >
                        <SelectTrigger className="w-64 mx-auto">
                          <SelectValue placeholder="ÌåÄ ÏÑ†ÌÉù" />
                        </SelectTrigger>
                        <SelectContent>
                          {userTeams.map((team) => (
                            <SelectItem key={team.id} value={team.id}>
                              {team.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <Button
                        disabled={!selectedTeamId}
                        onClick={() => {
                          if (!project || !selectedTeamId) return;
                          convertToTeamProject(project.id, selectedTeamId);
                          // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®
                          const updatedProjects = getProjects();
                          const updatedProject = updatedProjects.find(
                            (p) => p.id === project.id
                          );
                          if (updatedProject) setProject(updatedProject);
                          setShowTeamSelect(false);
                          setSelectedTeamId('');
                          toast({
                            title: 'ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Î°ú Î≥ÄÌôò ÏôÑÎ£å!',
                            description: 'Ïù¥Ï†ú ÌåÄ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.',
                          });
                        }}
                        className="w-64"
                      >
                        ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Î°ú Î≥ÄÌôò
                      </Button>
                    </div>
                  ) : (
                    <Button onClick={() => setShowTeamSelect(true)}>
                      ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Î°ú Î≥ÄÌôò
                    </Button>
                  )}
                </CardContent>
              </Card>
            )}
          </TabsContent>
          <TabsContent value="rewards" className="space-y-4">
            <RewardSystem project={project} />
          </TabsContent>
        </Tabs>

        {/* ÏûëÏóÖ Ï∂îÍ∞Ä Î™®Îã¨ */}
        <AddTaskModal
          projectId={project.id}
          isOpen={showAddTaskModal}
          onClose={() => setShowAddTaskModal(false)}
          onTaskAdded={handleTaskUpdate}
          createdBy={currentUser.id}
        />

        {/* Ïû¨Î∂ÑÌï¥ Î™®Îã¨ */}
        {project && (
          <ReprojectModal
            isOpen={showReprojectModal}
            onClose={() => setShowReprojectModal(false)}
            project={project}
            apiKey={apiKey}
            onReproject={handleReproject}
          />
        )}
      </div>
    </div>
  );
};

export default ProjectDetails;
